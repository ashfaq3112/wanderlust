<% layout("/layouts/boilerplate")%>

<% if(typeof success !== 'undefined' && success && success.length > 0) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert" id="successAlert">
        <%= success %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <script>
        setTimeout(() => {
            const alert = document.getElementById('successAlert');
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 3000);
    </script>
<% } %>

<% if(typeof error !== 'undefined' && error && error.length > 0) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert" id="errorAlert">
        <%= error %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <script>
        setTimeout(() => {
            const alert = document.getElementById('errorAlert');
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 5000);
    </script>
<% } %>

<div class="container my-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="mb-3">
                <h3 class="mb-0"><%= listing.title || "Untitled Listing" %></h3>
            </div>

            <div class="card listing-card">
                <img
                    class="card-img-top show-img"
                    src="<%= listing.image && listing.image.url ? listing.image.url : 'https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?w=1200' %>"
                    alt="listing_image"
                    onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?w=1200';"
                >
                <div class="card-body">
                    <p class="card-text">
                        <%= listing.description || "No description available" %>
                        <br>
                        <% if (listing.price) { %>
                            &#8377;<%= listing.price.toLocaleString("en-IN")%>
                        <% } %>
                        <br>
                        <%= listing.location || "" %>
                        <br>
                        <%= listing.country || "" %>
                    </p>
                    <% if (listing.owner) { %>
                        <p class="mt-2 mb-0 text-muted">
                            Owned by
                            <strong><%= listing.owner.username || listing.owner.email %></strong>
                        </p>
                    <% } %>
                </div>
            </div>
            <div class="d-flex justify-content-start gap-2 mt-3">
                <a href="/listings/<%= listing._id %>/edit" class="btn btn-outline-dark btn-sm">
                    Edit
                </a>
                <form method="post" action="/listings/<%= listing._id %>?_method=Delete" class="m-0">
                    <button class="btn btn-danger btn-sm" type="submit">Delete</button>
                </form>
            </div>
            
            <!-- Map Section -->
            <div class="mt-4">
                <h5><i class="fas fa-map-marker-alt text-danger"></i> Location</h5>
                <div id="map"></div>
            </div>
        </div>
    </div>
    <div class="mt-4">
        <% if (currentUser) { %>
            <h3> Leave a Review</h3>
            <form action="/listings/<%= listing._id %>/reviews" method="post" novalidate class="needs-validation">
                <div class="mb-3">
                    <label for="comment" class="form-label">Comment</label>
                    <textarea name="review[comment]" id="comment" class="form-control" required></textarea>
                    <div class="text-danger mt-1" id="comment-error" style="display: none;">Please provide review</div>
                </div>
                <div class="mb-3">
                    <label for="rating" class="form-label">Rating: </label>
                    <div class="star-rating" id="starRating">
                        <% for(let i = 1; i <= 5; i++) { %>
                            <i class="far fa-star star" data-rating="<%= i %>"></i>
                        <% } %>
                    </div>
                    <input type="hidden" name="review[rating]" id="rating" value="3" required>
                    <div class="text-danger mt-1" id="rating-error" style="display: none;">Please select a rating</div>
                </div>
                <button type="submit" class="btn btn-dark">Submit</button>
            </form>
            <script>
                const stars = document.querySelectorAll('.star');
                const ratingInput = document.getElementById('rating');
                let currentRating = 3;
                
                // Set initial rating
                updateStars(currentRating);
                
                stars.forEach((star, index) => {
                    star.addEventListener('click', () => {
                        currentRating = index + 1;
                        ratingInput.value = currentRating;
                        updateStars(currentRating);
                    });
                    
                    star.addEventListener('mouseenter', () => {
                        updateStars(index + 1);
                    });
                });
                
                document.getElementById('starRating').addEventListener('mouseleave', () => {
                    updateStars(currentRating);
                });
                
                function updateStars(rating) {
                    stars.forEach((star, index) => {
                        if (index < rating) {
                            star.classList.remove('far');
                            star.classList.add('fas', 'text-warning');
                        } else {
                            star.classList.remove('fas', 'text-warning');
                            star.classList.add('far');
                        }
                    });
                }

                // Form validation
                const reviewForm = document.querySelector('form[action*="/reviews"]');
                const commentField = document.getElementById('comment');
                const commentError = document.getElementById('comment-error');
                const ratingError = document.getElementById('rating-error');
                
                reviewForm.addEventListener('submit', function(e) {
                    const commentValue = commentField.value.trim();
                    let hasError = false;
                    
                    if (!commentValue) {
                        e.preventDefault();
                        commentError.style.display = 'block';
                        commentField.classList.add('is-invalid');
                        hasError = true;
                    } else {
                        commentError.style.display = 'none';
                        commentField.classList.remove('is-invalid');
                    }
                    
                    if (!ratingInput.value || ratingInput.value < 1 || ratingInput.value > 5) {
                        e.preventDefault();
                        ratingError.style.display = 'block';
                        hasError = true;
                    } else {
                        ratingError.style.display = 'none';
                    }
                    
                    if (hasError) {
                        return false;
                    }
                });
                
                // Hide errors when user starts typing
                commentField.addEventListener('input', function() {
                    if (this.value.trim()) {
                        commentError.style.display = 'none';
                        this.classList.remove('is-invalid');
                    }
                });
            </script>
        <% } else { %>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                You must be <a href="/login" class="alert-link">logged in</a> to leave a review.
            </div>
        <% } %>
        <hr class="my-4">
        <div class="reviews-section">
            <h3 class="mb-4">
                <i class="fas fa-star text-warning"></i> 
                Reviews 
                <% if (listing.reviews && listing.reviews.length > 0) { %>
                    <span class="badge bg-secondary ms-2"><%= listing.reviews.length %></span>
                <% } %>
            </h3>
            
            <% if (listing.reviews && listing.reviews.length > 0) { %>
                <div class="row g-4">
                    <% for(let review of listing.reviews){ %>
                        <% if (review && review.comment) { %>
                            <div class="col-md-6">
                                <div class="card review-card h-100 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div class="review-rating">
                                                <% if (review.rating) { %>
                                                    <% for(let i = 1; i <= 5; i++) { %>
                                                        <% if (i <= review.rating) { %>
                                                            <i class="fas fa-star text-warning"></i>
                                                        <% } else { %>
                                                            <i class="far fa-star text-secondary"></i>
                                                        <% } %>
                                                    <% } %>
                                                    <span class="ms-2 fw-bold"><%= review.rating %>/5</span>
                                                <% } %>
                                            </div>
                                            <% if (review.createdAt) { %>
                                                <small class="text-muted">
                                                    <i class="far fa-calendar-alt"></i>
                                                    <%= new Date(review.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %>
                                                </small>
                                            <% } %>
                                        </div>
                                        <p class="card-text review-comment mb-3">
                                            "<%= review.comment %>"
                                        </p>
                                        <% if (review.author) { %>
                                            <p class="text-muted mb-2">
                                                <small>
                                                    <i class="fas fa-user"></i>
                                                    <% if (review.author.username) { %>
                                                        <%= review.author.username %>
                                                    <% } else if (review.author.email) { %>
                                                        <%= review.author.email %>
                                                    <% } else { %>
                                                        Anonymous
                                                    <% } %>
                                                </small>
                                            </p>
                                        <% } %>
                                        <div class="d-flex gap-2 mt-3 pt-3 border-top">
                                            <% if (currentUser && (review.author && review.author.equals && review.author.equals(currentUser._id) || (listing.owner && listing.owner.equals && listing.owner.equals(currentUser._id)))) { %>
                                                <form method="post" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" class="m-0">
                                                    <button class="btn btn-danger btn-sm" type="submit">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </form>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% } %>
                    <% } %>
                </div>
            <% } else { %>
                <div class="text-center py-5">
                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                    <p class="text-muted fs-5">No reviews yet. Be the first to review!</p>
                </div>
            <% } %>
        </div>
    </div>
</div>

<script>
    // Wait for DOM to be fully loaded and Leaflet to be available
    document.addEventListener('DOMContentLoaded', function() {
        // Check if Leaflet is loaded
        if (typeof L === 'undefined') {
            console.error('Leaflet is not loaded');
            document.getElementById('map').innerHTML = '<div class="alert alert-warning">Map library failed to load. Please refresh the page.</div>';
            return;
        }
        
        try {
            // Initialize the map
            const map = L.map('map').setView([20.5937, 78.9629], 5); // Default to India center
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
            
            // Geocode the location and add marker
            const location = "<%= listing.location %>, <%= listing.country %>";
            console.log('Geocoding location:', location);
            
            // Use Nominatim API for geocoding (free, no API key required)
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Geocoding response:', data);
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        
                        console.log('Found coordinates:', lat, lon);
                        
                        // Set map view to the location
                        map.setView([lat, lon], 13);
                        
                        // Add a marker with enhanced popup
                        const marker = L.marker([lat, lon]).addTo(map);
                        
                        // Create custom popup content
                        const popupContent = `
                            <div style="min-width: 200px;">
                                <h6 style="margin: 0 0 8px 0; color: #333; font-weight: bold;">
                                    <%= listing.title %>
                                </h6>
                                <p style="margin: 4px 0; color: #666; font-size: 14px;">
                                    <i class="fas fa-map-marker-alt" style="color: #dc3545;"></i> ${location}
                                </p>
                                <% if (listing.price) { %>
                                    <p style="margin: 4px 0; color: #28a745; font-weight: bold; font-size: 14px;">
                                        <i class="fas fa-tag"></i> &#8377;<%= listing.price.toLocaleString("en-IN")%>/night
                                    </p>
                                <% } %>
                                <hr style="margin: 8px 0; border-top: 1px solid #eee;">
                                <small style="color: #999; font-size: 12px;">
                                    Click to explore this property
                                </small>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent, {
                            maxWidth: 250,
                            className: 'custom-popup'
                        }).openPopup();
                    } else {
                        console.log('Location not found');
                        // If geocoding fails, show a message
                        L.popup()
                            .setLatLng(map.getCenter())
                            .setContent('Location not found on map. Showing default view.')
                            .openOn(map);
                    }
                })
                .catch(error => {
                    console.error('Error geocoding location:', error);
                    // Show error message on map
                    L.popup()
                        .setLatLng(map.getCenter())
                        .setContent('Unable to load location. Showing default view.')
                        .openOn(map);
                });
                
        } catch (error) {
            console.error('Error initializing map:', error);
            document.getElementById('map').innerHTML = '<div class="alert alert-danger">Failed to initialize map. Please refresh the page.</div>';
        }
    });
</script>